---
title: "Tally rRNA Reads"
output: html_document
---

```{r}
source("run_config_2019.R")
library(GenomicFeatures)
library(Rsamtools)
library(rtracklayer)
library(knitr)
library(stringr)
library(tibble)
library(readr)
library(ggplot2)
```

## Determine rRNA Counts
```{r}
countsFromBam <- function(bam_file, gene_granges) {
  countBam(bam_file,
           param=ScanBamParam(which=gene_granges)) ->
    count_tab

  count_tab %>%
    pull(records) %>%
    sum %>%
    return
}

summarizeStarCounts <- function(star_count_file) {
  read_tsv(star_count_file, 
         col_names = c("gene_id", "unstranded", "first_strand", "second_strand")) ->
    star_counts
  
  star_counts %>%
    summarise(total = sum(second_strand))%>%
    pull(total) ->
    total_reads
  
  ### 3. Calculate "strand mapped reads" as sum of "second_strand" column minus "unmapped" reads from that column
  
  star_counts %>%
    filter(gene_id != "N_unmapped") %>%
    summarise(total = sum(second_strand))%>%
    pull(total) ->
    mapped_reads
  
  # total_reads
  # mapped_reads
  return(c(total_reads=total_reads, mapped_reads=mapped_reads))
}

percentRRNA = function(gtf_path, star_out_dir, bam_subset_regex=".*"){
  import(gtf_path, format="gtf") %>%
    subset(gene_biotype=="rRNA") %>%
    subset(type=="exon") ->
    rrna_granges
  #-------------------------------------
  list.files(star_out_dir, pattern = paste0(bam_suffix,"$"), full.names = TRUE) %>%
    path_filter(regex=bam_subset_regex) ->
    bamfiles

  countfiles = bamfiles %>%
    str_replace(bam_suffix, count_suffix)
  #-------------------------------------
  # print(bamfiles)
  # print(countfiles)
  #-------------------------------------
  bam_counts = as.data.frame(sapply(bamfiles, countsFromBam, rrna_granges)) %>%
    rownames_to_column  %>%
    mutate(sample=path_file(rowname)) %>%
    mutate(sample=str_replace(sample, bam_suffix,"")) %>%
    dplyr::select(sample, rrna_reads=2 )

  
  star_counts = t(sapply(countfiles, summarizeStarCounts)) %>%
    as.data.frame %>%
    rownames_to_column %>%
    mutate(sample=path_file(rowname)) %>%
    mutate(sample=str_replace(sample, count_suffix,"")) %>%
    dplyr::select(sample, total_reads, mapped_reads)
  
  star_counts
  
  combined_counts = full_join(star_counts, bam_counts, by="sample") %>%
    mutate(percent_mapped = 100 * mapped_reads/total_reads,
           rrna_percent_total = 100 * rrna_reads/total_reads,
           rrna_percent_mapped = 100 * rrna_reads/mapped_reads)

  # return(list(bam_counts, star_counts))
  return(combined_counts)

# 1. Use RSamtools to count reads mapping to rRNA genes
# 2. Calculate "total_reads" as sum of "second_strand" column
# 3. Calculate "strand mapped reads" as sum of "second_strand" column minus "unmapped" reads from that column
# 4. calculate rRNA_reads/total_reads and rRNA_reads/mapped_reads for each of the 2018 Total libraries
}
```




```{r}
enrich_compare_counts = percentRRNA(gtf_with_mito_rrna.file, enrich_compare_starout.dir, bam_subset_regex="_2018_P_")
```

## Merge rRNA Counts with Metadata

```{r}
enrich_compare_counts[1:6,1:6]
```


```{r}
metadata.df = read_tsv(metadata.file)

enrich_compare_counts %>%
  mutate(Label=str_extract(sample, "^\\d+_\\d+_[A-Z]_[HMT]\\d"), 
         lane=str_extract(sample, "L\\d{3}$")) %>%
  left_join(metadata.df, by="Label") ->
  enrich_compare_counts_with_meta

kable(enrich_compare_counts_with_meta)
```

## rRNA Reads as a portion of Total Reads
```{r}
ggplot(data=enrich_compare_counts_with_meta, 
       aes(x=SampleNum, y=rrna_percent_total, fill=lane)) +
  geom_bar(stat="identity", 
           position = position_dodge(preserve = "total"),
           color="black") +
  facet_grid(cols = vars(enrichment_method), scale="free_x") +
  scale_fill_brewer(guide=FALSE) +
  theme_bw() +
  labs(x = "Sample", y="% rRNA reads") +
  ylim(c(0,100))

```

## Mapped Reads as a portion of Total Reads
```{r}
ggplot(data=enrich_compare_counts_with_meta, 
       aes(x=SampleNum, y=percent_mapped, fill=lane)) +
  geom_bar(stat="identity", 
           position = position_dodge(preserve = "total"),
           color="black") +
  facet_grid(cols = vars(enrichment_method), scale="free_x") +
  scale_fill_brewer(guide=FALSE) +
  theme_bw() +
  labs(x = "Sample", y="% Reads Mapped") +
  ylim(c(0,100))

```

