---
title: "Enrichment Correlation"
output: html_document
---

```{r global_options, include=FALSE, echo=FALSE}
library(knitr)
knitr::opts_chunk$set(echo=TRUE, include=TRUE)
```

# Load paths and libraries
```{r include=FALSE}
source("shared_functions.R")
source("combined_config.R")

library(dplyr)
library(ggplot2)
library(DESeq2)
library(tibble)

fig_palette="Dark2"
```

# Analysis with Normalized Counts
## Load STAR Count Data
```{r}
starout_2019_dir %>%
  list.files(pattern = paste0("_2018_.*",count_suffix,"$"), full.names = TRUE) %>%
  loadStarCounts ->
  genecounts_2019_run

starout_2018_dir %>%
  list.files(pattern = paste0(count_suffix,"$"), full.names = TRUE) %>%
  loadStarCounts ->
  genecounts_2018_run
```

## Load Data in DESeq2
### Make Metadata dataframe for DESeq
```{r}
genecounts_2018_run %>%
  dplyr::select(expid) %>%
  dplyr::mutate(library=str_extract(expid, "^\\d+_[A-Z]+_[A-Z]"),
         exp_year=2018,
         enrichment_rep="1") %>%
  tidyr::separate(library, 
           into = c("RNA_sample_num", "enrichment_method",NA),
           sep="_", remove=FALSE) ->
  sample_df_2018

knitr::kable(sample_df_2018)
```

```{r}
genecounts_2019_run %>%
  select(expid) %>%
  mutate(library=str_extract(expid, "^\\d+_2018_[A-Z]+_[HMT]\\d"),
         exp_year=2019) %>%
  separate(library, 
           into = c("RNA_sample_num", NA, NA,"method_rep"),
           sep="_", remove=FALSE) %>%
  separate(method_rep, 
           into = c("enrichment_method", "enrichment_rep"),
           sep=1) ->
  sample_df_2019
knitr::kable(sample_df_2019)
 

bind_rows(sample_df_2018, sample_df_2019) %>%
  mutate(enrichment_method = case_when(enrichment_method == "H" ~ "RNaseH",
                                       enrichment_method %in% c("T","TOT") ~ "Total",
                                       enrichment_method %in% c("M","MA") ~ "PolyA",
                                       enrichment_method == "RZ" ~ "RiboZero")) %>%
  mutate(enrichment_method=factor(enrichment_method, 
                                  levels = c("Total", "RNaseH", "RiboZero", "PolyA"))) %>%
  column_to_rownames(var="expid") ->
  sample_df
knitr::kable(sample_df)
```

### Make Count Matrix for DESeq
```{r}
bind_rows(genecounts_2018_run, genecounts_2019_run) %>%
  # drop rRNA and rRNA homologs
  select(-all_of(strand_specific_rrna_homologs)) %>%
  column_to_rownames(var="expid") %>%
  as.matrix %>%
  t ->
  genecounts_for_desesq
# genecounts_for_desesq[1:6,1:6]
```

### Make DESeq object
```{r}
stopifnot(all(rownames(sample_df) == colnames(genecounts_for_desesq))) # Confirm that sample metadata and count columns are in the same order

DESeqDataSetFromMatrix(countData = genecounts_for_desesq,
                       colData = sample_df,
                       design = ~ enrichment_method) ->
  dds
colData(dds)

# Collapse Replicates
dds %>% collapseReplicates(object=., 
                           groupby=colData(.) %>% 
                             as_tibble %>%
                             pull(library)) ->
  dds
dds
```

```{r}
dds <- DESeq(dds)
```

## Calculate Group Mean of Normalized counts

```{r eval=FALSE, include=FALSE}
dds %>%
  counts(normalized=TRUE) ->
  norm_counts

norm_counts %>%
  as_tibble(rownames = "geneid") %>%
  select(., matches("_MA_|_M1"))
```

```{r eval=FALSE, include=FALSE}
norm_counts %>%
  as_tibble(rownames = "geneid") %>%
  select(., matches("_H[12]"))
```

```{r eval=FALSE, include=FALSE}
norm_counts %>%
  as_tibble(rownames = "geneid") %>%
  select(., matches("_TOT_|_T1"))
```

```{r eval=FALSE, include=FALSE}
norm_counts %>%
  as_tibble(rownames = "geneid") %>%
  select(., matches("_RZ_"))
```

```{r}
dds %>%
  counts(normalized=TRUE) ->
  norm_counts

norm_counts %>%
  as_tibble(rownames = "geneid") %>%
  mutate(ma_mean = rowMeans(select(., matches("_MA_|_M1"))),
         rz_mean = rowMeans(select(., matches("_RZ_"))),
         rh_mean = rowMeans(select(., matches("_H[12]"))),
         tot_mean = rowMeans(select(., matches("_TOT_|_T1")))) ->
  norm_counts_wmeans

```

```{r eval=FALSE, include=FALSE}
norm_counts_wmeans %>%
  ggplot(aes(x=tot_mean, y=rz_mean)) +
  geom_point()

```

## Calculate Pearson Correlations
```{r}
norm_counts_wmeans %>%
  {cor(pull(., tot_mean), pull(., rz_mean))} ->
  rz_cor

norm_counts_wmeans %>%
  {cor(pull(., tot_mean), pull(., ma_mean))} ->
  ma_cor

norm_counts_wmeans %>%
  {cor(pull(., tot_mean), pull(., rh_mean))} ->
  rh_cor
```

## Make Scatter Plots
```{r include=TRUE}

norm_counts_wmeans %>%
  summarise(max(ma_mean), max(rz_mean), max(rh_mean)) %>%
  max -> ymax


norm_counts_wmeans %>%
  ggplot(aes(x=tot_mean, y=value, color=variable)) + 
  geom_point(aes(y=ma_mean, color="ma_mean"), size=1) +
  geom_point(aes(y=rz_mean, color="rz_mean"), size=1) +
  geom_point(aes(y=rh_mean, color="rh_mean"), size=1) +
  theme_classic() +
  scale_colour_brewer(palette = fig_palette) ->
  correlation_scatterplot

correlation_scatterplot

correlation_scatterplot +
  scale_x_log10() + 
  scale_y_log10()
```
# Correlations of all Libraries with Average Total
## Pearson R Correlation
```{r}
set.seed(3)
norm_counts_wmeans %>%
  select(-geneid) %>%
  summarise_all(.funs=cor, y=pull(., tot_mean)) %>%
  t %>%
  as_tibble(rownames = "library") %>%
  dplyr::rename(cor_with_total="V1") ->
  pearson_df

dds %>%
  colData %>%
  as_tibble %>%
  left_join(pearson_df, by="library") %>%
  ggplot(aes(x=enrichment_method, y=cor_with_total, color=enrichment_method)) +
  geom_boxplot(fill=NA, color="grey70",outlier.color = NA, width=0.5) +
  geom_jitter(width=0.2, height=0, size = 4, stroke = 1, alpha=0.5) +
  scale_colour_brewer(palette = fig_palette, guide = FALSE) +
  ylab("Correlation") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

Values in this figure were determined by first normalizing the per gene read counts for each library.  An "average total" was then determined by averaging the norrmalized read counts for each gene across all total samples.  The Pearson correlation was then calculated between the average total and the normalized gene counts for each library.  All total libraries are highly correlated with the average total, indicating that biological and technical replicates are all very similar.  The RNaseH libraries are better correlated with the average total than Ribo Zero libraries and Poly A libraries, with Poly A libraries having the worst correlation.

## Kendall's Tau Correlation  
```{r}
set.seed(3)
norm_counts_wmeans %>%
  select(-geneid) %>%
  summarise_all(.funs=cor, y=pull(., tot_mean), method="kendall") %>%
  t %>%
  as_tibble(rownames = "library") %>%
  dplyr::rename(cor_with_total="V1") ->
  kendall_df

dds %>%
  colData %>%
  as_tibble %>%
  left_join(kendall_df, by="library") %>%
  ggplot(aes(x=enrichment_method, y=cor_with_total, color=enrichment_method)) +
  geom_boxplot(fill=NA, color="grey70",outlier.color = NA, width=0.5) +
  geom_jitter(width=0.2, height=0, size = 4, stroke = 1, alpha=0.5) +
  scale_colour_brewer(palette = fig_palette, guide = FALSE) +
  ylab("Correlation") +
  ggtitle("Correlation with Average Total") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


# SessionInfo
```{r}
sessionInfo()
```

