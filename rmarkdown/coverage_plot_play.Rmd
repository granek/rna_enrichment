---
title: "Mito coverage plots"
output:
  html_document:
    toc: false
---

```{r}
library(Rsamtools)
library(ggbio)
library(fs)
# library(dplyr)
library(GenomicAlignments)
# library(stringr)
library(rtracklayer)
library(tidyverse)
library(plyr)



bam_dir = "/workspace/2018_tot_samples/star_out"
seq_dir = "/workspace/2018_tot_samples/seq_out"
dir.create(seq_dir)

# get paths from source run_star_config.sh?
genome_fasta = ("/workspace/2018_tot_samples/genome/Cryptococcus_neoformans_var_grubii_h99.CNA3.dna.toplevel.fa")
h99_genome = readDNAStringSet(genome_fasta)

# Strip descriptions from chrom names
h99_genome %>%
  names %>%
  str_extract("\\w+") ->
  names(h99_genome)

# full_mito_name = str_subset(names(h99_genome), "Mt") # pull the full name of the mito sequence from fasta
# short_mito_name = str_extract(full_mito_name, "\\w+")
short_mito_name = "Mt"
small_mito_rrna_id = "15s_mito_rrna"
large_mito_rrna_id = "21s_mito_rrna"

```



```{r}
tot_bam_files = dir_ls(bam_dir,glob = "*TOT*L00*.bam") 
tot_bams = BamFileList(tot_bam_files, paste0(tot_bam_files, ".bai"))
tot_bam_files
```

```{r}
tot_L1_bam_files = dir_ls(bam_dir,glob = "*TOT*L001*.bam") 
tot_L1_bams = BamFileList(tot_L1_bam_files, paste0(tot_L1_bam_files, ".bai"))
tot_L1_bam_files
```
# Whole Genome
```{r}
cur_range = GRanges(seqnames = "Mt", 
                              IRanges(1, 26000), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```


# 21s rRNA region
```{r}
range_21s_region = GRanges(seqnames = short_mito_name, 
                              IRanges(6500, 9500), strand = "*")

autoplot(tot_L1_bams, which = range_21s_region) +
  xlim(range_21s_region)
```

## 21s rRNA Left End

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(6705, 6740), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(6705, 6712), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(6705, 6710), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(6705, 6711), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```
left end looks like 6710


## 21s rRNA Right End
```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(9000, 9500), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(9300, 9329), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20))
```
Right end looks like 9326

## Check Strand

```{r}
region_21s_plus = GRanges(seqnames = short_mito_name, 
                              IRanges(6500, 9500), strand = "+")
region_21s_plus.overlaps = summarizeOverlaps(region_21s_plus, tot_L1_bams)
assay(region_21s_plus.overlaps)
```

```{r}
region_21s_minus = GRanges(seqnames = short_mito_name, 
                              IRanges(6500, 9500), strand = "-")
region_21s_minus.overlaps = summarizeOverlaps(region_21s_minus, tot_L1_bams)
assay(region_21s_minus.overlaps)
```
Vast majoring of reads are + strand, so 21s rRNA gene must be - strand

## 21s rRNA annotation
```{r}
gene_21s = GRanges(seqnames = short_mito_name, 
                   IRanges(6710, 9326), strand = "-")
gene_21s
names(gene_21s) = "large_mito_rRNA"

```






# 15s rRNA region
```{r}
range_15s_region = GRanges(seqnames = short_mito_name, 
                              IRanges(16950, 18500), strand = "*")

autoplot(tot_L1_bams, which = range_15s_region) +
  xlim(range_15s_region)
```

## 15s rRNA Left End

```{r}
range_15s_region = GRanges(seqnames = short_mito_name, 
                              IRanges(17000, 17175), strand = "*")

autoplot(tot_L1_bams, which = range_15s_region) +
  xlim(range_15s_region)
```

```{r}
range_15s_region = GRanges(seqnames = short_mito_name, 
                              IRanges(17000, 17100), strand = "*")

autoplot(tot_L1_bams, which = range_15s_region) +
  xlim(range_15s_region)
```

```{r}
range_15s_region = GRanges(seqnames = short_mito_name, 
                              IRanges(16940, 16980), strand = "*")

autoplot(tot_L1_bams, which = range_15s_region) +
  xlim(range_15s_region)  +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 20))
```

left end looks like 16948?


## 15s rRNA Right End
```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(18000, 18500), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```


```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(18290, 18315), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(18310, 18315), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```

```{r}
cur_range = GRanges(seqnames = short_mito_name, 
                              IRanges(18314, 18317), strand = "*")

autoplot(tot_L1_bams, which = cur_range) +
  xlim(cur_range)
```
Right end looks like 18316

## Check Strand
left end looks like 16948?
Right end looks like 18316

```{r}
region_15s_plus = GRanges(seqnames = short_mito_name, 
                              IRanges(16948, 18316), strand = "+")
region_15s_plus.overlaps = summarizeOverlaps(region_15s_plus, tot_L1_bams)
assay(region_15s_plus.overlaps)
```

```{r}
region_15s_minus = GRanges(seqnames = short_mito_name, 
                              IRanges(16948, 18316), strand = "-")
region_15s_minus.overlaps = summarizeOverlaps(region_15s_minus, tot_L1_bams)
assay(region_15s_minus.overlaps)
```
Vast majoring of reads are - strand, so 15s rRNA gene must be + strand

## 15s rRNA annotation
```{r}
gene_15s = GRanges(seqnames = short_mito_name, 
                   ranges=IRanges(16948, 18316), strand = "+")
names(gene_15s) = "small_mito_rRNA"
```

# Extract and output 15s and 21s rRNA sequences


```{r}

seqnames(gene_15s)
# seq_15s = getSeq(h99_genome, mito_name)
seq_15s = getSeq(h99_genome, gene_15s)
names(seq_15s) = "small_mito_rRNA__CNA3"
seq_21s = getSeq(h99_genome, gene_21s)
names(seq_21s) = "large_mito_rRNA__CNA3"

writeXStringSet(seq_15s, file.path(seq_dir, "small_mito_rRNA__CNA3.fasta"), format="fasta")
writeXStringSet(seq_21s, file.path(seq_dir, "large_mito_rRNA__CNA3.fasta"), format="fasta")
```

Fred's h99 mito anotation: https://www.ncbi.nlm.nih.gov/nucleotide/AY101381.1

# Export rRNA gene coordinates as GTF
https://support.bioconductor.org/p/70054/

```{r}
# ? export.gff
mito_rrna_gtf.file = file.path(seq_dir, "mito_rrna.gtf")

export(GRangesList(gene_15s, gene_21s), 
       con = mito_rrna_gtf.file,
       format="gff2")

read_lines(mito_rrna_gtf.file)
```

```{r}
h99_gtf.file = "/workspace/2018_tot_samples/genome/Cryptococcus_neoformans_var_grubii_h99.CNA3.39.gtf"
h99_gtf = read_tsv(h99_gtf.file,
                   col_names = c("seqname", "source", "feature", "start", "end", "score", 
                       "strand", "frame", "attributes"),
                   cols(seqname = col_character(),
                        source = col_character(),
                        feature = col_character(),
                        start = col_double(),
                        end = col_double(),
                        score = col_character(),
                        strand = col_character(),
                        frame = col_character(),
                        attributes = col_character()
                        ),
                   comment = "#"
         )

mito_rrna_gtf = read_tsv(mito_rrna_gtf.file,
                   col_names = c("seqname", "source", "feature", "start", "end", "score", 
                       "strand", "frame", "attributes"),
                   cols(seqname = col_character(),
                        source = col_character(),
                        feature = col_character(),
                        start = col_double(),
                        end = col_double(),
                        score = col_character(),
                        strand = col_character(),
                        frame = col_character(),
                        attributes = col_character()
                        ),
                   comment = "#"
         )
```

```{r}
h99_gtf %>%
  filter(str_detect(attributes, "CNAG_10500")) 
```

```{r}
h99_gtf %>%
  filter(str_detect(attributes, 'gene_biotype "rRNA"')) %>%
  filter(feature=="exon")
```

```{r}
h99_gtf %>%
  filter(str_detect(attributes, 'gene_biotype "rRNA"')) %>%
  filter(feature=="exon") %>%
  select(attributes) ->
  x
x[[1]]
```

```{r}

make_df_from_gr = function(gr_vec){
  attr_template = 'gene_id "XGENEIDX"; transcript_id "XGENEIDX-1"; exon_number "1"; gene_name "XGENEIDX"; gene_source "JAG"; gene_biotype "rRNA"; transcript_name "XGENEIDX"; transcript_source "JAG"; transcript_biotype "rRNA"; exon_id "XGENEIDX-1-1";'
  attr = str_replace_all(attr_template, fixed("XGENEIDX"), names(gr_vec))
  
  names(gr_vec)
  print(attr_template)
  print(attr)
  gr_vec %>%
    as.tibble %>%
    add_column(attributes=attr, source="JAG", feature="exon", score=".", frame=".") %>%
    select(seqname=seqnames, source, feature, start, end, score, 
                       strand, frame, attributes)
    
}

ldply(GRangesList(gene_15s, gene_21s), make_df_from_gr)
```



```{bash}
# head /workspace/2018_tot_samples/genome/Cryptococcus_neoformans_var_grubii_h99.CNA3.39.gtf
grep -i rRNA /workspace/2018_tot_samples/genome/Cryptococcus_neoformans_var_grubii_h99.CNA3.39.gtf

```

```{bash}
grep CNAG_10500 /workspace/2018_tot_samples/star_out/*_L001_ReadsPerGene.out.tab
```


# Play

```{r eval=FALSE, include=FALSE}
cur_range = GRanges(seqnames = short_mito_name,
                              IRanges(6500, 9500), strand = "*")

curbam = tot_bams[[1]]
autoplot(curbam, which = cur_range, color="red") +
  xlim(cur_range) +
  ggtitle(basename(curbam$path))

curbam = tot_bams[[5]]
autoplot(curbam, which = cur_range, color="red") +
  xlim(cur_range) +
  ggtitle(basename(curbam$path))
```


