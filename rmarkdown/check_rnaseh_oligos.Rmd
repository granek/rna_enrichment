---
title: "Run STAR on TOTAL samples"
output:
  html_document:
    toc: false
---

```{r}
source("run_config.R")
```


# Download and Index Genome
```{bash}
set -u
mkdir -p $GENOME_WITH_MITO_RRNA_DIR
wget --no-verbose --directory-prefix ${GENOME_WITH_MITO_RRNA_DIR} ${FA_URL} 
gunzip -f ${FA_WITH_MITO_RRNA}.gz
```


```{bash}
set -u
mkdir -p ${MITO_RRNA_STAR_OUT}
STAR \
    --runMode genomeGenerate \
    --genomeDir $GENOME_WITH_MITO_RRNA_DIR \
    --genomeFastaFiles ${FA_WITH_MITO_RRNA} \
    --sjdbGTFfile ${GTF_WITH_MITO_RRNA} \
    --outFileNamePrefix ${MITO_RRNA_STAR_OUT}/genome_ \
    --genomeSAindexNbases 11
# --genomeSAindexNbases 6
```

## Check oligos
```{bash}
set -u
SAMPLE="rrna_oligos"
mkdir -p ${MITO_RRNA_STAR_OUT}
    STAR \
    --runMode alignReads \
    --runThreadN $THREADS \
    --genomeDir $GENOME_WITH_MITO_RRNA_DIR \
    --outSAMtype BAM SortedByCoordinate \
    --quantMode GeneCounts \
    --genomeLoad NoSharedMemory \
    --twopassMode None \
    --limitBAMsortRAM 1280000000 \
    --outFileNamePrefix ${MITO_RRNA_STAR_OUT}/${SAMPLE}_ \
    --outFilterScoreMinOverLread 0 --outFilterMatchNminOverLread 0 \
    --outFilterMatchNmin 0 --outFilterMismatchNmax 2 \
    --readFilesIn $RRNA_OLIGOS_FASTQ        
        
    samtools index ${MITO_RRNA_STAR_OUT}/${SAMPLE}_Aligned.sortedByCoord.out.bam
```

## How is STAR counting multimappers
There are some reads from CNAG_10500 that map to an unannotated region between CNAG_10503 and CNAG_03595.  How does STAR count these?  I would like to know for correctly tallying the percentage of reads in total samples that map to rRNA.

### Load STAR table of reads per gene
```{r}
star_oligo_readspergene.path = file.path(mito_rrna_star_out.dir,"rrna_oligos_ReadsPerGene.out.tab")

# load reads per gene count table, dropping rows with all zeroes
read_tsv(star_oligo_readspergene.path, 
         col_names = c("gene_id", "unstranded", "first_strand", "second_strand")) %>%
  filter_at(vars(-gene_id), any_vars(. != 0)) ->
  oligo_read_counts

oligo_read_counts

oligo_read_counts %>%
  summarise_at(vars(-gene_id), sum)
```

### Count number of oligos generated for each rRNA gene
These values should be the same as the the STAR count table above
```{r}
read_tsv(rrna_oligos.file) %>%
  pull(oligo_name) %>%
  str_split("__", simplify = TRUE) %>%
  as_tibble %>%
  dplyr::rename(gene_id="V1", gene_oligo_num="V2") %>%
  group_by(gene_id) %>%
  summarise(total_counts = n()) ->
  generated_oligo_counts
  
generated_oligo_counts

generated_oligo_counts %>%
  summarise(total = sum(total_counts))

```

# SessionInfo
```{r}
sessionInfo()
```
